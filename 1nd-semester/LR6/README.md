# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ ¬´–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å¬ª

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–∞ —è–∑—ã–∫–µ Python, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è "–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å" –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç —á–µ—Ä–µ–∑ API –¶–µ–Ω—Ç—Ä–æ–±–∞–Ω–∫–∞ –†–§. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –∏ —É–≤–µ–¥–æ–º–ª—è—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫—É—Ä—Å–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å

–û–±—ä–µ–∫—Ç ‚Äî –≤–µ–±-—Å–µ—Ä–≤–µ—Ä Flask –∏–ª–∏ FastAPI, Tornado.
–ù–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ - –∫–ª–∏–µ–Ω—Ç—ã, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–µ HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—ã, —Å–≤—è–∑—ã–≤–∞—é—â–∏–µ—Å—è —Å –æ–±—ä–µ–∫—Ç–æ–º —Å –ø–æ–º–æ—â—å—é –≤–µ–±-—Å–æ–∫–µ—Ç–æ–≤. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞.
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é
–ò–∑—É—á–∏—Ç–µ –ø—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ö–µ–º—ã —à–∞–±–ª–æ–Ω–∞ ¬´–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å¬ª: https://refactoringguru.cn/ru/design-patterns/observer/python/example. 

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–¥: 

https://github.com/tornadoweb/tornado/tree/stable/demos/chat
https://github.com/tornadoweb/tornado/tree/stable/demos/websocket
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: 

–û–±—ä–µ–∫—Ç (Subject) –±—É–¥–µ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å API –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤.
–ù–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ (Observers) –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫—É—Ä—Å–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–∞–ª—é—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, USD, EUR, GBP).


## –ü–æ–ª—É—á–µ–Ω–Ω—ã–π —Å–∞–π—Ç
![]()


## –ö–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã
```
import asyncio
import json
from datetime import datetime
from abc import ABC, abstractmethod

import aiohttp
from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from fastapi.responses import HTMLResponse
import uvicorn

# ----------- –ü–∞—Ç—Ç–µ—Ä–Ω "–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å" -----------

class Observer(ABC):
    @abstractmethod
    async def update(self, currency_data):
        pass


class CurrencySubject:
    """–°—É–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–ª–µ–¥–∏—Ç –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç"""
    def __init__(self):
        self._observers = []
        self._currency_data = {}

    def add_observer(self, observer):
        self._observers.append(observer)

    def remove_observer(self, observer):
        if observer in self._observers:
            self._observers.remove(observer)

    async def notify_observers(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤—Å–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º"""
        for observer in self._observers[:]:
            try:
                await observer.update(self._currency_data)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏: {e}")
                self.remove_observer(observer)

    async def update_currency_data(self):
        """–ó–∞–ø—Ä–æ—Å –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç —Å —Å–∞–π—Ç–∞ –¶–ë –†–§"""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get('https://www.cbr-xml-daily.ru/daily_json.js') as response:
                    if response.status == 200:
                        data = json.loads(await response.text())
                        currencies = {
                            'USD': data['Valute']['USD']['Value'],
                            'EUR': data['Valute']['EUR']['Value'],
                            'GBP': data['Valute']['GBP']['Value'],
                            'CNY': data['Valute']['CNY']['Value']
                        }

                        if currencies != self._currency_data:
                            self._currency_data = currencies
                            await self.notify_observers()
                            print(f"[{datetime.now().isoformat()}] –û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: {currencies}")

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–∞–ª—é—Ç: {e}")


# ----------- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å -----------

class WebSocketObserver(Observer):
    def __init__(self, websocket: WebSocket, client_id: str):
        self.websocket = websocket
        self.client_id = client_id

    async def update(self, currency_data):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç—É"""
        message = {
            "client_id": self.client_id,
            "currency_data": currency_data,
            "timestamp": datetime.now().isoformat()
        }
        await self.websocket.send_text(json.dumps(message, ensure_ascii=False))


# ----------- FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -----------

app = FastAPI()
currency_subject = CurrencySubject()
client_counter = 0

HTML_PAGE = """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –¶–ë –†–§</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: #b39adb;
            margin: 0;
            padding: 40px;
            color: black;
        }
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: #9adbb3;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }


        h1 {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        .status {
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            font-weight: 500;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        #clientInfo {
            text-align: center;
            font-size: 16px;
            margin-bottom: 20px;
            color: white;
            position: relative;
            z-index: 1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            position: relative;
            z-index: 1;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
        }
        th {
            background-color: #dbb39a;
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) td {
            background-color: white;
        }
        #lastUpdate {
            text-align: right;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –¶–ë –†–§</h1>
        <div id="clientInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="status" class="status disconnected">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

        <table id="currencyTable">
            <thead>
                <tr>
                    <th>–í–∞–ª—é—Ç–∞</th>
                    <th>–ö—É—Ä—Å (‚ÇΩ)</th>
                </tr>
            </thead>
            <tbody id="currencyBody">
                <tr><td colspan="2">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
            </tbody>
        </table>

        <div id="lastUpdate">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: -</div>
    </div>

    <script>
        let clientId = null;
        let ws = null;

        function connect() {
            ws = new WebSocket("ws://localhost:8000/ws");

            ws.onopen = function() {
                document.getElementById("status").className = "status connected";
                document.getElementById("status").textContent = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É";
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.client_id && !clientId) {
                    clientId = data.client_id;
                    document.getElementById("clientInfo").textContent = `–ö–ª–∏–µ–Ω—Ç: ${clientId}`;
                }

                if (data.currency_data) {
                    updateTable(data.currency_data, data.timestamp);
                }
            };

            ws.onclose = function() {
                document.getElementById("status").className = "status disconnected";
                document.getElementById("status").textContent = "‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...)";
                setTimeout(connect, 3000);
            };
        }

        function updateTable(data, timestamp) {
            const tbody = document.getElementById("currencyBody");
            tbody.innerHTML = "";
            for (const [currency, value] of Object.entries(data)) {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${getCurrencyName(currency)}</td>
                    <td>${value.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            }
            document.getElementById("lastUpdate").textContent = 
                "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " + new Date(timestamp).toLocaleString();
        }

        function getCurrencyName(code) {
            const names = {
                "USD": "üá∫üá∏ –î–æ–ª–ª–∞—Ä –°–®–ê",
                "EUR": "üá™üá∫ –ï–≤—Ä–æ",
                "GBP": "üá¨üáß –§—É–Ω—Ç —Å—Ç–µ—Ä–ª–∏–Ω–≥–æ–≤",
                "CNY": "üá®üá≥ –ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å"
            };
            return names[code] || code;
        }

        connect();
    </script>
</body>
</html>
"""



@app.get("/")
async def index():
    return HTMLResponse(HTML_PAGE)


@app.websocket("/ws")
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    """WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º"""
    global client_counter
    await websocket.accept()
    client_counter += 1
    client_id = f"client_{client_counter}"

    observer = WebSocketObserver(websocket, client_id)
    currency_subject.add_observer(observer)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await websocket.send_text(json.dumps({
        "client_id": client_id,
        "message": "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    }, ensure_ascii=False))

    # ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ (–µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
    if currency_subject._currency_data:
        await observer.update(currency_subject._currency_data)
    else:
        # –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è
        await websocket.send_text(json.dumps({
            "client_id": client_id,
            "currency_data": {},
            "message": "–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—Å–∞—Ö –≤–∞–ª—é—Ç..."
        }, ensure_ascii=False))

    try:
        while True:
            data = await websocket.receive_text()
            if data == "ping":
                await websocket.send_text(json.dumps({"type": "pong"}))
    except WebSocketDisconnect:
        print(f"–ö–ª–∏–µ–Ω—Ç {client_id} –æ—Ç–∫–ª—é—á–∏–ª—Å—è")
        currency_subject.remove_observer(observer)


# ----------- –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ -----------

async def currency_updater():
    while True:
        await currency_subject.update_currency_data()
        await asyncio.sleep(60)


@app.on_event("startup")
async def startup_event():
    asyncio.create_task(currency_updater())


if __name__ == "__main__":
    uvicorn.run(app, host="localhost", port=8000)
```
